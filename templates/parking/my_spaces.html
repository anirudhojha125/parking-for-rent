{% extends "base.html" %}

{% block title %}My Parking Spaces - Smart Park System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>My Parking Spaces</h2>
    <a href="{{ url_for('parking.add_space') }}" class="btn btn-primary">Add New Space</a>
</div>

{% if spaces %}
    <div class="row">
        {% for space in spaces %}
            <div class="col-md-4 mb-4">
                <div class="card">
                    {% if space.images and space.images|length > 0 %}
                        <!-- Display the primary image or first image if no primary is set -->
                        {% set primary_image = space.images|selectattr('is_primary')|first %}
                        {% if not primary_image %}
                            {% set primary_image = space.images|first %}
                        {% endif %}
                        {% if primary_image %}
                            <img src="{{ primary_image.image_url }}" class="card-img-top" alt="{{ space.title }}" style="height: 200px; object-fit: cover;">
                        {% else %}
                            <div class="card-img-top bg-light" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                <span class="text-muted">Parking Space Images</span>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="card-img-top bg-light" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                            <span class="text-muted">No Image Available</span>
                        </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ space.title }}</h5>
                        <p class="card-text">{{ space.description[:100] }}{% if space.description|length > 100 %}...{% endif %}</p>
                        <p class="card-text"><strong>Address:</strong> {{ space.address }}</p>
                        <p class="card-text"><strong>Price:</strong> ₹{{ "%.2f"|format(space.price_per_hour) }} per hour</p>
                        <p class="card-text">
                            <strong>Availability:</strong> 
                            {{ space.availability_start.strftime('%H:%M') }} - {{ space.availability_end.strftime('%H:%M') }}
                        </p>
                        <p class="card-text">
                            <strong>Status:</strong> 
                            {% if space.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                            {% set owner_rating = space.owner.get_average_rating() %}
                            {% if owner_rating %}
                                <br><strong>Your Rating:</strong> 
                                <span class="badge bg-warning">
                                    ★ {{ "%.1f"|format(owner_rating) }} ({{ space.owner.get_total_ratings() }} ratings)
                                </span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="card-footer">
                        <a href="{{ url_for('parking.view_space', space_id=space.id) }}" class="btn btn-sm btn-outline-primary">View</a>
                        <a href="{{ url_for('parking.edit_space', space_id=space.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
                        <form method="POST" action="{{ url_for('parking.delete_space', space_id=space.id) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this parking space?')">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-5">
        <h4>You haven't listed any parking spaces yet</h4>
        <p class="text-muted">Start earning money by listing your unused parking spaces!</p>
        <a href="{{ url_for('parking.add_space') }}" class="btn btn-primary">Add Your First Space</a>
    </div>
{% endif %}
{% endblock %}